{% var rows = (data || []); %}
{% var curr = null; %}

<div class="print-heading text-center">
	<h2>{{ __("Case Entries Activity Log") }}</h2>
	<p class="text-muted">
		{{ __("From") }}: {%= (filters && filters.from_date) || "—" %} ·
		{{ __("To") }}: {%= (filters && filters.to_date) || "—" %} ·
		{{ __("School") }}: {%= (filters && filters.school) || __("All") %} ·
		{{ __("Program") }}: {%= (filters && filters.program) || __("All") %}
	</p>
</div>

{% for (var i = 0; i < rows.length; i++) { var r = rows[i]; %}
	{% if (r.referral_case !== curr) {
		if (curr !== null) { %></tbody></table>{% }
		curr = r.referral_case; %}
		<!-- Case header -->
		<h4 style="margin-top:10mm;">
			{{ __("Case") }}: {%= curr %}
			<small class="text-muted">
				· {{ __("Student") }}: {%= r.student_full_name || r.student || "" %}
				· {{ __("Program") }}: {%= r.program || "" %}
				· {{ __("Case Manager") }}: {%= r.case_manager_name || "" %}
			</small>
		</h4>

		<table class="table table-bordered">
			<thead>
				<tr>
					<th style="width:30mm;">{{ __("Date") }}</th>
					<th style="width:28mm;">{{ __("Type") }}</th>
					<th style="width:35mm;">{{ __("Assignee") }}</th>
					<th>{{ __("Summary") }}</th>
				</tr>
			</thead>
			<tbody>
	{% } %}

	<tr>
		<td>{%= r.entry_date_pretty || "" %}</td>
		<td>{%= r.entry_type || "" %}</td>
		<td>{%= r.assignee || "" %}</td>
		<td>
			{%
				var txt = String(r.summary_raw || "")
					.replace(/<[^>]+>/g, "")
					.replace(/\s+/g, " ")
					.trim();
				if (txt.length > 300) txt = txt.slice(0, 300).replace(/\s+\S*$/, "") + "…";
			%}
			{%= txt %}
		</td>
	</tr>

{% } %}
{% if (rows.length) { %}</tbody></table>{% } %}

<style>
@media print { thead { display: table-header-group; } tfoot { display: table-footer-group; } }
.table th,.table td { vertical-align: top; }
</style>
