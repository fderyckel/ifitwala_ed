<!-- base_template: ifitwala_ed/templates/sp_base.html -->
{% set page_title = _("Self-Referral") %}

{% block page_actions %}{% endblock %}

{% block content %}
<section class="mb-3" aria-labelledby="crisisHelp">
	<div class="alert alert-danger d-flex align-items-start gap-2 mb-0">
		<i class="bi bi-exclamation-triangle-fill fs-5"></i>
		<div>
			<h2 id="crisisHelp" class="h6 mb-1">{{ _("Need immediate help?") }}</h2>
			<p class="mb-0 small">
				{{ _("If you or someone else is in immediate danger, contact local emergency services right now. This form is not monitored 24/7.") }}
			</p>
		</div>
	</div>
</section>

<form id="self-referral-wizard" class="card shadow-sm" novalidate>
	<div class="card-body">
		<ol class="breadcrumb small mb-3" id="wizard-steps" aria-label="{{ _('Steps') }}">
			<li class="breadcrumb-item active" data-step-index="1">{{ _("1. Read & Consent") }}</li>
			<li class="breadcrumb-item" data-step-index="2">{{ _("2. What’s going on") }}</li>
			<li class="breadcrumb-item" data-step-index="3">{{ _("3. Contact preferences") }}</li>
			<li class="breadcrumb-item" data-step-index="4">{{ _("4. Review & submit") }}</li>
		</ol>

		<!-- STEP 1 -->
		<div class="wizard-step" data-step="1">
			<h2 class="h5 mb-2">{{ _("Before you start") }}</h2>
			<p class="text-muted small">
				{{ _("Your message goes directly to the school counsellor team. They will review it during school hours. You can choose what to share. If it's urgent, please use the crisis options above.") }}
			</p>
			<div class="form-check mb-2">
				<input class="form-check-input" type="checkbox" id="consent" required>
				<label class="form-check-label" for="consent">
					{{ _("I understand this is not an emergency service and consent to share this information with the counsellor team.") }}
				</label>
			</div>
			<div class="form-text small">
				{{ _("Confidentiality: By default, your submission will be visible to the school counsellor case team only.") }}
			</div>
		</div>

		<!-- STEP 2 -->
		<div class="wizard-step d-none" data-step="2">
			<h2 class="h5 mb-2">{{ _("What’s going on?") }}</h2>

			<div class="row g-3">
				<div class="col-md-6">
					<label class="form-label" for="referral_category">{{ _("Referral Category") }}</label>
					<select id="referral_category" name="referral_category" class="form-select" required>
						<option value="">{{ _("Select…") }}</option>
						<option>Social</option>
						<option>Emotional</option>
						<option>Pastoral</option>
						<option>Academic</option>
						<option>Behavior</option>
						<option>Attendance</option>
					</select>
				</div>

				<div class="col-md-6">
					<label class="form-label" for="severity">{{ _("Severity") }}</label>
					<select id="severity" name="severity" class="form-select" required>
						<option value="">{{ _("Select…") }}</option>
						<option>Low</option>
						<option>Moderate</option>
						<option>High</option>
						<option>Critical</option>
					</select>
				</div>

				<div class="col-12">
					<label class="form-label" for="referral_description">{{ _("Describe what you’d like us to know") }}</label>
					<textarea id="referral_description" name="referral_description" class="form-control" rows="6" placeholder="{{ _('Write in your own words…') }}" required></textarea>
					<div class="form-text small">{{ _("Please avoid sharing passwords or highly sensitive private information.") }}</div>
				</div>

				<div class="col-12">
					<div class="form-check">
						<input class="form-check-input" type="checkbox" id="reporting_for_other">
						<label class="form-check-label" for="reporting_for_other">
							{{ _("I’m concerned for a friend (peer referral)") }}
						</label>
					</div>
				</div>

				<div class="col-md-6 d-none" id="subject-student-wrap">
					<label class="form-label" for="subject_student">{{ _("Friend’s Student ID or Name") }}</label>
					<input type="text" id="subject_student" name="subject_student" class="form-control" placeholder="{{ _('Type their name or ID…') }}">
					<div class="form-text small">{{ _("We’ll match this securely when your submission is processed.") }}</div>
				</div>

				<div class="col-12">
					<label class="form-label" for="attachments">{{ _("Attachments (optional)") }}</label>
					<input class="form-control" type="file" id="attachments" multiple>
					<div class="form-text small">{{ _("Images or PDFs only. You can also add these later with our help.") }}</div>
				</div>
			</div>
		</div>

		<!-- STEP 3 -->
		<div class="wizard-step d-none" data-step="3">
			<h2 class="h5 mb-2">{{ _("How can we contact you?") }}</h2>

			<div class="row g-3">
				<div class="col-md-6">
					<label class="form-label" for="preferred_contact_method">{{ _("Preferred contact method") }}</label>
					<select id="preferred_contact_method" name="preferred_contact_method" class="form-select">
						<option>Email</option>
						<option>In-app</option>
						<option>Phone</option>
					</select>
				</div>

				<div class="col-md-6">
					<div class="form-check mt-4">
						<input class="form-check-input" type="checkbox" id="ok_to_contact_guardians" name="ok_to_contact_guardians">
						<label class="form-check-label" for="ok_to_contact_guardians">
							{{ _("It’s okay to contact my guardians if necessary") }}
						</label>
					</div>
				</div>

				<div class="col-12">
					<label class="form-label" for="safe_times_to_contact">{{ _("Safe times to contact (optional)") }}</label>
					<input type="text" id="safe_times_to_contact" name="safe_times_to_contact" class="form-control" placeholder="{{ _('e.g., Lunch, after school, not during Math…') }}">
				</div>
			</div>
		</div>

		<!-- STEP 4 -->
		<div class="wizard-step d-none" data-step="4">
			<h2 class="h5 mb-2">{{ _("Review") }}</h2>
			<p class="text-muted small mb-3">
				{{ _("Please review your information below. When you submit, it goes to the counsellor case team only. You’ll see next steps after submitting.") }}
			</p>

			<div class="border rounded p-3" id="review-panel" aria-live="polite">
				<p class="mb-1"><strong>{{ _("Category") }}:</strong> <span data-review="referral_category">—</span></p>
				<p class="mb-1"><strong>{{ _("Severity") }}:</strong> <span data-review="severity">—</span></p>
				<p class="mb-1"><strong>{{ _("For a friend") }}:</strong> <span data-review="reporting_for_other">—</span></p>
				<p class="mb-1 d-none" id="review-subject"><strong>{{ _("Friend") }}:</strong> <span data-review="subject_student">—</span></p>
				<p class="mb-1"><strong>{{ _("Preferred contact") }}:</strong> <span data-review="preferred_contact_method">—</span></p>
				<p class="mb-1"><strong>{{ _("Guardians OK") }}:</strong> <span data-review="ok_to_contact_guardians">—</span></p>
				<div class="mt-2">
					<strong class="d-block">{{ _("Your message") }}:</strong>
					<div class="small text-muted" data-review="referral_description">—</div>
				</div>
			</div>

			<div class="alert alert-info small mt-3 mb-0">
				<i class="bi bi-shield-lock me-1"></i>
				{{ _("Confidentiality: this will be visible to the counsellor case team only by default.") }}
			</div>
		</div>

		<hr class="my-3">

		<div class="d-flex align-items-center justify-content-between">
			<button type="button" class="btn btn-outline-secondary" data-action="prev" disabled>
				<i class="bi bi-chevron-left me-1"></i>{{ _("Back") }}
			</button>
			<div class="ms-auto d-flex gap-2">
				<button type="button" class="btn btn-primary" data-action="next">
					{{ _("Continue") }}<i class="bi bi-chevron-right ms-1"></i>
				</button>
				<button type="submit" class="btn btn-success" data-action="submit" disabled title="{{ _('Backend wiring comes in next step') }}">
					<i class="bi bi-send-check me-1"></i>{{ _("Submit") }}
				</button>
			</div>
		</div>
	</div>
</form>
{% endblock %}

{% block scripts %}
<script>
(() => {
	"use strict";

	const form = document.getElementById("self-referral-wizard");
	if (!form) return;

	const steps = Array.from(form.querySelectorAll(".wizard-step"));
	const crumbs = Array.from(document.querySelectorAll("#wizard-steps .breadcrumb-item"));
	const btnPrev = form.querySelector('[data-action="prev"]');
	const btnNext = form.querySelector('[data-action="next"]');
	const btnSubmit = form.querySelector('[data-action="submit"]');

	let current = 1;

	function showStep(n) {
		current = Math.max(1, Math.min(4, n));
		steps.forEach(s => s.classList.toggle("d-none", s.dataset.step != current));
		crumbs.forEach(c => c.classList.toggle("active", Number(c.dataset.stepIndex) === current));
		btnPrev.disabled = current === 1;
		btnNext.classList.toggle("d-none", current === 4);
		btnSubmit.classList.toggle("d-none", current !== 4);
	}

	const peerToggle = form.querySelector("#reporting_for_other");
	const subjectWrap = form.querySelector("#subject-student-wrap");
	const reviewSubject = document.querySelector("#review-subject");
	if (peerToggle) {
		peerToggle.addEventListener("change", () => {
			const on = peerToggle.checked;
			subjectWrap?.classList.toggle("d-none", !on);
			reviewSubject?.classList.toggle("d-none", !on);
		});
	}

	function canAdvance() {
		if (current === 1) return form.querySelector("#consent")?.checked;
		if (current === 2) {
			const cat = form.querySelector("#referral_category")?.value;
			const sev = form.querySelector("#severity")?.value;
			const desc = form.querySelector("#referral_description")?.value?.trim();
			return Boolean(cat && sev && desc && desc.length >= 10);
		}
		return true;
	}

	function updateReview() {
		const map = {
			referral_category: "referral_category",
			severity: "severity",
			referral_description: "referral_description",
			reporting_for_other: ["reporting_for_other", v => v ? "{{ _('Yes') }}" : "{{ _('No') }}"],
			subject_student: "subject_student",
			preferred_contact_method: "preferred_contact_method",
			ok_to_contact_guardians: ["ok_to_contact_guardians", v => v ? "{{ _('Yes') }}" : "{{ _('No') }}"]
		};
		for (const [key, val] of Object.entries(map)) {
			const el = Array.isArray(val) ? form.querySelector("#" + val[0]) : form.querySelector("#" + val);
			const out = document.querySelector('[data-review="' + key + '"]');
			if (!out) continue;
			let value = "—";
			if (el) {
				if (el.tagName === "SELECT") value = el.value || "—";
				else if (el.type === "checkbox") value = el.checked;
				else value = (el.value || "").trim() || "—";
				if (Array.isArray(val) && typeof val[1] === "function") value = val[1](value);
			}
			out.textContent = value;
		}
	}

	btnNext?.addEventListener("click", () => {
		if (!canAdvance()) { form.classList.add("was-validated"); return; }
		if (current === 3) updateReview();
		showStep(current + 1);
	});

	btnPrev?.addEventListener("click", () => showStep(current - 1));

	form.addEventListener("submit", async (e) => {
		e.preventDefault();
		btnSubmit.disabled = true;

		const payload = {
			referral_category: form.querySelector("#referral_category")?.value || "",
			severity: form.querySelector("#severity")?.value || "",
			referral_description: form.querySelector("#referral_description")?.value || "",
			preferred_contact_method: form.querySelector("#preferred_contact_method")?.value || "",
			ok_to_contact_guardians: form.querySelector("#ok_to_contact_guardians")?.checked ? 1 : 0,
			safe_times_to_contact: form.querySelector("#safe_times_to_contact")?.value || ""
		};

		// Phase 1b (peer referral) - harmless if fields don't exist yet
		const peer = form.querySelector("#reporting_for_other");
		if (peer) {
			payload.reporting_for_other = peer.checked ? 1 : 0;
			const subj = form.querySelector("#subject_student")?.value || "";
			if (peer.checked && subj) payload.subject_student = subj;
		}

		try {
			const { message } = await frappe.call({
				method: "ifitwala_ed.utilities.portal_utils.create_self_referral",
				type: "POST",
				args: payload
			});
			const name = message?.name;

			// Upload attachments (sequential, simple)
			const input = form.querySelector("#attachments");
			if (name && input && input.files && input.files.length) {
				for (const file of Array.from(input.files)) {
					const fd = new FormData();
					fd.append("referral_name", name);
					fd.append("file", file, file.name);
					const resp = await fetch("/api/method/ifitwala_ed.utilities.portal_utils.upload_self_referral_file", {
						method: "POST",
						body: fd,
						headers: { "X-Frappe-CSRF-Token": frappe.csrf_token }
					});
					if (!resp.ok) {
						console.error("Upload failed:", file.name, await resp.text());
						frappe.msgprint({
							title: "{{ _('Some files failed to upload') }}",
							message: "{{ _('You can add attachments later with a counselor.') }}",
							indicator: "orange",
						});
					}
				}
			}

			frappe.msgprint({
				title: "{{ _('Submitted') }}",
				message: name
					? "{{ _('Thank you. Your message has been sent to the counsellor team.') }}<br>{{ _('Reference:') }} <b>" + name + "</b>"
					: "{{ _('Thank you. Your message has been sent to the counsellor team.') }}",
				indicator: "green",
			});
			setTimeout(() => { window.location.href = "{{ portal_root or '/sp' }}/wellbeing"; }, 1200);
		} catch (err) {
			console.error(err);
			frappe.msgprint({
				title: "{{ _('Could not submit') }}",
				message: "{{ _('Please review your entries and try again. If the problem persists, contact the school counsellor.') }}",
				indicator: "red",
			});
		} finally {
			btnSubmit.disabled = false;
		}
	});

	showStep(1);
})();
</script>
{% endblock %}
