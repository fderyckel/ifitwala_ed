{% extends "templates/web.html" %}

{% block title %}{{ _(page_title or "My Student Logs") }}{% endblock %}

{% block page_content %}
<div class="container my-4" id="student-logs-root">
	<div class="d-flex align-items-center justify-content-between mb-3">
		<h3 class="mb-0">{{ _("My Student Logs") }}</h3>
		<div class="text-muted small">{{ _("Student") }}: {{ student_name }}</div>
	</div>

	<!-- List -->
	<div id="log-list" class="list-group">
		{% if initial_logs and initial_logs|length %}
			{% for row in initial_logs %}
				<a href="javascript:void(0)"
				   class="list-group-item list-group-item-action student-log-row"
				   data-log-name="{{ row.name }}"
				   aria-label="{{ row.log_type }} {{ row.date }}">
					<div class="d-flex w-100 justify-content-between">
						<h6 class="mb-1">
							<span class="me-2 text-secondary">{{ row.date }}</span>
							{% if row.time %}<span class="me-2 text-secondary">{{ row.time }}</span>{% endif %}
							<span class="fw-semibold">{{ row.log_type }}</span>
						</h6>
						{% if row.follow_up_status %}
							<span class="badge bg-secondary">{{ row.follow_up_status }}</span>
						{% endif %}
					</div>
					<div class="small text-muted">
						{{ _("Author") }}: {{ row.author_name or "-" }}
						{% if row.program %} • {{ _("Program") }}: {{ row.program }}{% endif %}
						{% if row.academic_year %} • {{ _("Year") }}: {{ row.academic_year }}{% endif %}
					</div>
				</a>
			{% endfor %}
		{% else %}
			<div class="alert alert-info mb-0">{{ _("No logs available yet.") }}</div>
		{% endif %}
	</div>

	<!-- Load more -->
	<div class="text-center my-3">
		<button id="load-more" class="btn btn-outline-primary">
			{{ _("Load more") }}
		</button>
		<div id="load-spinner" class="spinner-border ms-2 d-none" role="status" aria-hidden="true"></div>
	</div>
</div>

<!-- Detail Modal -->
<div class="modal fade" id="logModal" tabindex="-1" aria-labelledby="logModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg modal-dialog-scrollable">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="logModalLabel">{{ _("Log Details") }}</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
			</div>
			<div class="modal-body">
				<div class="mb-2">
					<div class="small text-muted" id="modal-meta"></div>
					<div id="modal-badges" class="mt-2"></div>
				</div>
				<hr class="my-2">
				<div id="modal-log-html" class="student-log-html"></div>
				<div id="modal-reference" class="mt-3 small text-muted d-none"></div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("Close") }}</button>
			</div>
		</div>
	</div>
</div>

<script>
(() => {
	// Config (avoid raw Jinja injection in JS expressions)
	const PAGE_LEN = Number("{{ page_length or 20 }}") || 20;
	let offset = document.querySelectorAll('.student-log-row').length;
	let loading = false;

	const listEl = document.getElementById('log-list');
	const loadBtn = document.getElementById('load-more');
	const spinner = document.getElementById('load-spinner');

	// Bootstrap modal
	const modalEl = document.getElementById('logModal');
	let modal;
	function ensureModal() {
		if (!modal) {
			modal = new bootstrap.Modal(modalEl);
		}
		return modal;
	}

	function setLoading(state) {
		loading = state;
		loadBtn.disabled = state;
		spinner.classList.toggle('d-none', !state);
	}

	async function fetchMore() {
		if (loading) return;
		setLoading(true);
		try {
			const r = await frappe.call({
				method: "ifitwala_ed.www.sp.student_logs.get_student_logs",
				args: { start: offset, page_length: PAGE_LEN }
			});
			const rows = (r && r.message) ? r.message : [];
			if (!rows.length) {
				loadBtn.classList.add('d-none');
				return;
			}
			offset += rows.length;
			rows.forEach(addRow);
		} catch (e) {
			console.error(e);
			frappe.msgprint({ title: __("Error"), message: __("Could not load more logs."), indicator: "red" });
		} finally {
			setLoading(false);
		}
	}

	function addRow(row) {
		const a = document.createElement('a');
		a.href = "javascript:void(0)";
		a.className = "list-group-item list-group-item-action student-log-row";
		a.dataset.logName = row.name;

		const statusBadge = row.follow_up_status
			? '<span class="badge bg-secondary">' + frappe.utils.escape_html(row.follow_up_status) + '</span>'
			: '';

		a.innerHTML =
			'<div class="d-flex w-100 justify-content-between">' +
				'<h6 class="mb-1">' +
					'<span class="me-2 text-secondary">' + frappe.datetime.str_to_user(row.date) + '</span>' +
					(row.time ? '<span class="me-2 text-secondary">' + row.time + '</span>' : '') +
					'<span class="fw-semibold">' + frappe.utils.escape_html(row.log_type || "") + '</span>' +
				'</h6>' +
				statusBadge +
			'</div>' +
			'<div class="small text-muted">' +
				__( "Author" ) + ': ' + frappe.utils.escape_html(row.author_name || "-") +
				(row.program ? ' • ' + __( "Program" ) + ': ' + frappe.utils.escape_html(row.program) : '') +
				(row.academic_year ? ' • ' + __( "Year" ) + ': ' + frappe.utils.escape_html(row.academic_year) : '') +
			'</div>';

		a.addEventListener('click', () => openDetail(row.name));
		listEl.appendChild(a);
	}

	async function openDetail(name) {
		try {
			const r = await frappe.call({
				method: "ifitwala_ed.www.sp.student_logs.get_log_detail",
				args: { name }
			});
			const d = r.message || {};

			const parts = [];
			if (d.date) parts.push(__( "Date" ) + ": " + frappe.datetime.str_to_user(d.date));
			if (d.time) parts.push(__( "Time" ) + ": " + d.time);
			if (d.author_name) parts.push(__( "Author" ) + ": " + d.author_name);
			if (d.log_type) parts.push(__( "Type" ) + ": " + d.log_type);
			if (d.program) parts.push(__( "Program" ) + ": " + d.program);
			if (d.academic_year) parts.push(__( "Year" ) + ": " + d.academic_year);
			document.getElementById('modal-meta').textContent = parts.join(" • ");

			const badges = document.getElementById('modal-badges');
			badges.innerHTML = "";
			if (d.follow_up_status) {
				const span = document.createElement('span');
				span.className = "badge bg-secondary";
				span.textContent = d.follow_up_status;
				badges.appendChild(span);
			}

			document.getElementById('modal-log-html').innerHTML = d.log_html || "";

			const refEl = document.getElementById('modal-reference');
			if (d.reference_type && d.reference_name) {
				refEl.classList.remove('d-none');
				refEl.innerHTML =
					__( "Reference" ) + ': ' +
					'<span class="text-body">' + frappe.utils.escape_html(d.reference_type) + '</span>' +
					'<span class="mx-1">/</span>' +
					'<span class="text-body">' + frappe.utils.escape_html(d.reference_name) + '</span>';
			} else {
				refEl.classList.add('d-none');
				refEl.innerHTML = "";
			}

			ensureModal().show();
		} catch (e) {
			console.error(e);
			frappe.msgprint({ title: __("Error"), message: __("Could not load the log details."), indicator: "red" });
		}
	}

	// Wire initial rows to click handlers
	document.querySelectorAll('.student-log-row').forEach(el => {
		el.addEventListener('click', () => openDetail(el.dataset.logName));
	});

	// Load more
	loadBtn.addEventListener('click', fetchMore);

	// Hide "Load more" if initial set is already smaller than PAGE_LEN
	const INITIAL_COUNT = document.querySelectorAll('.student-log-row').length;
	if (INITIAL_COUNT < PAGE_LEN) {
		loadBtn.classList.add('d-none');
	}
})();
</script>

{% endblock %}
