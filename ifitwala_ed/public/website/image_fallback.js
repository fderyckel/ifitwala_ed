// image_fallback.js

/**
 * Image fallback loader for the Ifitwala Ed site
 * Handles fallbacks depending on declared fallback strategy:
 * - carousel: large -> medium -> original
 * - card: small -> original
 * 
 * Relies on:
 *  - fallback attribute: "carousel" or "card"
 *  - data-src-* attributes generated by smart_image macro
 */

document.addEventListener("DOMContentLoaded", function () {
  const images = document.querySelectorAll("img[fallback]");

  images.forEach((img) => {
    const strategy = img.getAttribute("fallback");
    const src = img.getAttribute("src");

    const srcSmall = img.dataset.srcSmall || null;
    const srcMedium = img.dataset.srcMedium || null;
    const srcOriginal = img.dataset.srcOriginal || null;

    // Debug info
    console.debug(`[Fallback] Strategy: ${strategy} | Initial: ${src}`);

    img.addEventListener("load", () => {
      img.classList.add("loaded");
    });

    img.addEventListener("error", () => {
      if (strategy === "carousel") {
        if (img.src.endsWith(src) && srcMedium) {
          console.warn("[Fallback] Large failed. Trying medium:", srcMedium);
          img.src = srcMedium;
        } else if (img.src === srcMedium && srcOriginal) {
          console.warn("[Fallback] Medium failed. Trying original:", srcOriginal);
          img.src = srcOriginal;
        } else {
          console.error("[Fallback] All carousel sources failed:", img.alt || img);
        }
      } else if (strategy === "card") {
        if (img.src.endsWith(src) && srcOriginal) {
          console.warn("[Fallback] Small failed. Trying original:", srcOriginal);
          img.src = srcOriginal;
        } else {
          console.error("[Fallback] All card sources failed:", img.alt || img);
        }
      }
    });
  });
});


