// image_fallback.js

/**
 * Image fallback loader for the Ifitwala Ed site
 * Handles fallbacks depending on declared fallback strategy:
 * - carousel: large -> medium -> original
 * - card: small -> original
 * 
 * Relies on:
 *  - fallback attribute: "carousel" or "card"
 *  - data-src-* attributes generated by smart_image macro
 */

document.addEventListener("DOMContentLoaded", function () {
  const images = document.querySelectorAll("img[fallback]");

  images.forEach((img) => {
    const strategy    = img.getAttribute("fallback");

    const initialSrc  = img.getAttribute("src"); // <-- CHANGED

    const srcMedium   = img.dataset.srcMedium   || null;
    const srcOriginal = img.dataset.srcOriginal || null;

    console.debug(`[Fallback] Strategy: ${strategy} | Starting src: ${initialSrc}`);

    img.addEventListener("load", () => {
      img.classList.add("loaded");
    });

    img.addEventListener("error", () => {
      const current = img.getAttribute("src"); // <-- CHANGED

      if (strategy === "carousel") {
        if (current === initialSrc && srcMedium) {
          console.warn("[Fallback] Large failed. Trying medium:", srcMedium);
          img.setAttribute("src", srcMedium); // <-- CHANGED

        } else if (current === srcMedium && srcOriginal) {
          console.warn("[Fallback] Medium failed. Trying original:", srcOriginal);
          img.setAttribute("src", srcOriginal); // <-- CHANGED

        } else {
          console.error("[Fallback] All carousel sources failed:", img.alt || img);
        }

      } else if (strategy === "card") {
        if (current === initialSrc && srcOriginal) {
          console.warn("[Fallback] Small failed. Trying original:", srcOriginal);
          img.setAttribute("src", srcOriginal); // <-- CHANGED

        } else {
          console.error("[Fallback] All card sources failed:", img.alt || img);
        }
      }
    });
  });
});



